version: 2.1

jobs:
  test:
    docker:
      - image: circleci/ruby:2.5.3
        environment:
          RAILS_ENV: test
      - image: circleci/mysql:5.6
        environment:
          MYSQL_ALLOW_EMPTY_PASSWORD: true
          MYSQL_ROOT_PASSWORD: ""
          MYSQL_DATABASE: railsdatabase
    working_directory: ~/sampleApp
    steps:
      - checkout
      - run:
          name: bundle install
          command: bundle install --path vendor/bundle
      - run:
          name: Setup NodeJS and Yarn
          command: |
            # Install NVM
            curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh | bash
            echo 'export NVM_DIR="/opt/circleci/.nvm"' >> $BASH_ENV
            echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> $BASH_ENV
            source $BASH_ENV

            # Install NodeJS
            nvm install v11.9.0
            nvm alias default v11.9.0

            # Install Yarn
            # npm install -g yarn@1.13.0
      - run:
          name: データベースの起動を待機
          command: dockerize -wait tcp://127.0.0.1:3306 -timeout 1m

      - run:
          name: データベースのセットアップ
          command: bundle exec rake db:schema:load
      - run:
          name: テストの実行
          command: bundle exec rspec
      - run:
          name: テストのテスト
          command: "ruby test/models/guest_test.rb"

workflows:
  version: 2.1
  workflows:
    jobs:
      - test
